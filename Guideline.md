#ガイドライン

##課題内容
簡易的なIaaSを作成しなさい．
ただし，以下のことができるように実装すること．

1. 指定したVMイメージを台数分立ち上げる
2. プライベートNWを作ってインターネットに接続する

##ネットワークモデル
本課題においては，
スイッチから成るネットワーク（以下ネットワーク）をインターネットとみなし，
以下のノードから構成されるネットワークモデルを考える．

* エンドユーザ端末（以下ユーザ端末）
* 管理用端末
* スイッチ
* コントローラ
* VMマネージャ
* VM

（図）

ユーザ端末，管理用端末，VMマネージャ及びVMサーバはそれぞれ
ネットワークに接続されており，
ネットワークを介してのみ通信が可能である．

また，VMはVMマネージャの管理下に設置されるものとする．

スイッチはスイッチ同士の相互接続により
ネットワークを構築している．

###ユーザ端末
ユーザ端末はスイッチと接続されることでネットワークを介して
他端末と通信することができる．

ただし，通信時には宛先のIPアドレスを知っている必要があるため，
VMマネージャ及びVMマネージャから通知されたVMとしか通信できない．
（他のユーザ端末や管理用端末，スイッチのコントローラとは通信できない）

VMマネージャに対し，
Rest APIを通して，
VMの割り当て要求，割り当て解除要求，割り当て確認要求（これらをVM管理要求とする）の送信及びそれらの結果の受信を行う．

###管理用端末
管理用端末はスイッチと接続されることでネットワークを介して
他端末と通信することができる．

ネットワークを管理するための端末であり，
スイッチのコントローラ，VMマネージャと通信できる．

また，Webインターフェース及びRest APIを通してコントローラと通信し，
ユーザ端末，スイッチ及びVMを含めたスライス/トポロジの状態を確認することができる．

###スイッチ
スイッチは，スイッチ同士で相互に接続することでネットワークを構成する．
それぞれのスイッチはMACアドレスの書き換えが可能なルータとして動作する．

また，コントローラからFlowModやPacketOutを受け取り，フローテーブルの内容を変更する．

###コントローラ
コントローラは，各スイッチと接続されており，
OpenFlowのメッセージを用いてスイッチに指示を与えることができる．

トポロジ情報，スライス情報を管理しており，
管理用端末に対しこれらの情報を開示する．

###VMマネージャ
VMマネージャは，スイッチと接続されることでネットワークを介して
他端末と通信することができる．

VMマネージャは，VMの管理を行うための機能及びその機能を持つサーバそのものであり，
VM自体もこのサーバ内部に設置される．

Rest APIを通してコントローラと通信することができ，
VM管理要求を送信したユーザ端末，要求内容及び関連するVMの情報をもとに
ネットワークスライスの構築及び削除を要求することができる．

###VM
IPアドレスが設定された，VMマネージャ内に設置された端末である．


##ユーザ用CLI
ユーザ用CLIはRest APIを用いてVMマネージャにVM管理要求を送信する．

CLIはコマンドamncliで実行され，
サブコマンドによって各VM管理要求を送信する．

```
amncli <subcommand>
```

サブコマンドには以下の4つが存在する．

* run: VMの利用開始要求を送信する．-nオプションを利用することでVMの台数を設定できる．
* stop: VMの利用停止要求を送信する．
* show: VMの利用状況確認要求を送信する．
* help: amncliコマンドの説明を表示する．

16台のVMを利用開始する場合の実行例は以下の通り．
```
amncli run -n 16
```

###VMの利用開始要求
<VMマネージャのIP>/api/run/で表されるURIに対し，
```
{"client": <ユーザ端末のIPアドレス>,"number": <利用するVM台数>}
```
で表されるJSONをHTTP POSTメソッドによって送信する．

###VMの利用停止要求
<VMマネージャのIP>/api/stop/で表されるURIに対し，
```
{"client": <ユーザ端末のIPアドレス>}
```
で表されるJSONをHTTP POSTメソッドによって送信する．

###VMの利用状況確認要求
<VMマネージャのIP>/api/show/で表されるURIに対し，
```
{"client": <ユーザ端末のIPアドレス>}
```
で表されるJSONをHTTP POSTメソッドによって送信する．

##管理用CLI
（検討中）

##Webインターフェース（管理用）
Webインターフェースは簡易なHTMLファイルで実装され，
更新ボタンを押下することで現在のトポロジ情報及びスライス状態を表示する．

###更新方法
Webインターフェース内に更新ボタンを配置し，
これをクリックすることでコントローラに状態表示要求を行う（詳細は「Rest APIの実行」を参照）．

###Rest APIの実行
<コントローラのIP>/api/status/で表されるURIに対し，
HTTP GETメソッドによって状態表示を要求する．

結果としてコントローラからは
トポロジ及びスライスの状態を表示するhtmlファイルが返される．

※実装としては，htmlのformタグで実装．

##VMマネージャ
VMマネージャはユーザ端末からVM管理要求を受け取り，指定された処理を実行し，結果を返す．
また，
VMの状態が変更されたことによりスライスの変更が必要な場合はコントローラへ通知を行う．

###構成
VMマネージャは外部につながるインターフェースを2つ持つ．
1つは，VMマネージャ自身がユーザ端末やコントローラと通信するための制御用インターフェース，
もう1つは，VMマネージャの機能により設置されたVMとネットワークをつなぐデータ用インターフェースである．

制御用インターフェース側にVMマネージャのIPアドレスが設定されており，
データ用インターフェース側はIPアドレスの設定を行わない．

※データ用インターフェースに関しては，他端末（VM）宛てのパケットを受け取るため，VBのネットワークアダプタ設定でプロミスキャスの項目を「すべて許可」にしておく必要がある．

また，VMマネージャはクライアントとなるユーザ端末と，クライアントが利用しているVM及びそれらの端末が属するスライスの対応を保持している．
対応は以下のようなエントリを持つテーブル（VMテーブルとする）として所持しておく．

entry = clientIP, VM IP list, slice

※実装上は連想配列だろうとクラス切って配列だろうとなんでも構いません

###Rest API
VMマネージャは，ユーザ端末からRest APIを通してVM管理要求を受け取る．
受信するJSONメッセージの構成は前節を参照のこと．

受信した要求の種類により，
VM利用開始処理，VM利用停止処理，VM利用状況確認処理を実行する．

###VM利用開始処理
受け取ったJSONメッセージから，
"client"と"num"というオブジェクトを受け取る．

"num"オブジェクトで指定された台数のVMを立ち上げ，それぞれのIPアドレスを設定し，
そのリストを1行に1つのIPという形式で
ユーザ端末へ実行結果を返す．

```
---------
status: running
client: 192.168.1.3
vm list:
1 192.168.1.100
2 192.168.1.101
3 192.168.1.102
---------
```

ここで
"client"オブジェクトで指定されたユーザ端末及び本処理で追加されたVMについては
プライベートネットワークの構成ノードとなるため，
新たなスライスを設定する必要がある．

そのため，
Rest APIを実行することで新たなスライスを作成し，
クライアントおよびVMをそのスライスに追加する（「Rest APIの実行」項を参照のこと）．

その後，クライアントのIP，VMのIPリスト，スライス名を対応付けてVMテーブルに格納する．

###VM利用停止処理
受け取ったJSONメッセージから
クライアントのIPアドレスを"client"オブジェクトから受け取る．

VMテーブルの中からクライアントのIPアドレスに一致する項目を探索し，
クライアントおよびVMリスト内のVMを
Rest APIの実行によってスライスから削除するようコントローラに指示する．
さらに，これらが属していたスライスの削除も同様にコントローラに指示する．

終了後，該当エントリをVMテーブルから削除し，
結果をユーザ端末に返す．
実行結果は以下のようなフォーマットとする．

```
---------
status: deleted
client: 192.168.1.3
vm list:
1 192.168.1.100
2 192.168.1.101
3 192.168.1.102
---------
```

###VM利用状況確認処理
受け取ったJSONメッセージから
クライアントのIPアドレスを"client"オブジェクトから受け取る．

VMテーブルの中からクライアントのIPアドレスに一致する項目を探索し，
VMのIPリストを結果として返す．
実行結果は以下のようなフォーマットとする．

```
---------
status: running
client: 192.168.1.3
vm list:
1 192.168.1.100
2 192.168.1.101
3 192.168.1.102
---------
```

###Rest APIの実行
VMマネージャは，VMの追加及び削除によってスライスの構成が変更される場合に，
コントローラへ指示を行う．

この指示はRest APIを通して行われる．
ただし，このときのURIやJSONの仕様については前課題（スライス）のものを利用することとする．

結果としてコントローラからは
スライス情報更新完了のメッセージが返される．


##コントローラ
コントローラはVMマネージャからスライスに関する命令を受け取り，
スライス及びスライスへのホストの追加/削除を行う．

また，経路選択やトポロジ形成，IPアドレスを利用したパケット転送を行うためのFlowMod/Packet Outをスイッチに送信する．

ただし，
スライスに追加するホストの情報に関しては，
MACアドレスを格納していた前回課題とは異なり，
IPアドレスを格納する

また，前回課題で生成していたトポロジ/スライス状態を表示したHTMLファイルについては
管理用Webインターフェース内に設置するボタンも配置することとする．

※こうしないと，一回更新ボタン押したら，ブラウザバックしないと更新できなくなる

###ルーティング処理の追加
前回課題においては，スイッチはL2のスイッチとして実装されており，
IPアドレスに基づくパケット転送ができない．

そのため，ルーティングスイッチのコードを参考に
L3のルータとしての機能を追加する必要がある．
（このとき，送信元/宛先IPアドレスはパケットが宛先に届くまで保持され，送信元/宛先MACアドレスはスイッチを経由するたびに書き換えられる）

###Rest API
Rest APIについては前回課題と同じ仕様を用いる．

追加の仕様として，
<コントローラのIP>/api/status/で表されるURIで
管理用端末から受け取ったGETメッセージに対しては
前回課題で出力していたトポロジ/スライス状態を表示したHTMLファイルを返す．





###VM要求処理

VM要求処理の流れは図の通りである。

.
.
![overview image](https://github.com/handai-trema/IaaS-amn/blob/develop/picture/sequence_VMdemand.png?raw=true)
.
.


### IPアドレスの割当

各機器に割り当てられるIPアドレスを以下に示す。

| 機器 | IP アドレス | 
|:-----------|------------:|
| スイッチ    |     192.168.1.1 | 
| VMマネージャ     |      192.168.1.2 〜 192.168.1.3  |
| 管理用端末       |        192.168.1.4 〜 192.168.1.9  |  
| VM         |          192.168.1.10 〜 192.168.1.199 | 
| ユーザ端末       |       192.168.1.200 〜 192.168.1.232 | 
| other    |     192.168.1.233 〜 192.168.1.253 | 
| コントローラ       |        192.168.1.254 | 

